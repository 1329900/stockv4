

<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการคลังวัสดุ - กลุ่มงานระบาดวิทยา</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/th.js"></script>
    <!-- เพิ่ม SheetJS (xlsx) สำหรับการส่งออก Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary-color: #0F4C3A;
            --secondary-color: #1A7A5A;
            --light-color: #F5F5F5;
            --gray-color: #6B7280;
            --dark-gray: #374151;
        }
        
        * {
            font-family: 'Sarabun', sans-serif;
        }
        
        body {
            background-color: var(--light-color);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
        }
        
        .btn-secondary {
            background-color: var(--gray-color);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-secondary:hover {
            background-color: var(--dark-gray);
        }
        
        .btn-danger {
            background-color: #DC2626;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-danger:hover {
            background-color: #B91C1C;
        }
        
        .btn-success {
            background-color: #10B981;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-success:hover {
            background-color: #059669;
        }
        
        .nav-link {
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            transition: all 0.2s;
        }
        
        .nav-link:hover, .nav-link.active {
            background-color: var(--secondary-color);
        }
        
        .form-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }
        
        .form-input:focus {
            outline: 2px solid var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #E5E7EB;
        }
        
        th {
            background-color: var(--primary-color);
            color: white;
        }
        
        tr:nth-child(even) {
            background-color: #F9FAFB;
        }
        
        .expire-warning {
            color: #DC2626;
            font-weight: 500;
        }
        
        .expire-soon {
            color: #F59E0B;
            font-weight: 500;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow: auto;
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 1.5rem;
            border-radius: 0.5rem;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: black;
        }
        
        .barcode-input {
            font-size: 1.25rem;
            padding: 0.75rem;
            border: 2px solid var(--primary-color);
            border-radius: 0.375rem;
            width: 100%;
            margin-bottom: 1rem;
        }
        
        .barcode-input:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(26, 122, 90, 0.2);
        }
        
        .print-only {
            display: none;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            
            .print-only {
                display: block;
            }
            
            body {
                background-color: white;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center bg-gray-100">
        <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
            <div class="text-center mb-6">
                <h1 class="text-2xl font-bold text-[#0F4C3A]">ระบบจัดการคลังวัสดุ</h1>
                <p class="text-gray-600">กลุ่มงานระบาดวิทยา</p>
            </div>
            
            <div id="loginError" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4 hidden"></div>
            
            <form id="loginForm">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="email">อีเมล</label>
                    <input class="form-input" id="email" type="email" placeholder="อีเมล" required>
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="password">รหัสผ่าน</label>
                    <input class="form-input" id="password" type="password" placeholder="รหัสผ่าน" required>
                </div>
                
                <div class="flex items-center justify-between">
                    <button class="btn-primary w-full" type="submit">เข้าสู่ระบบ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app" class="hidden">
        <!-- Navigation -->
        <nav class="bg-[#0F4C3A] text-white shadow-md">
            <div class="container mx-auto px-4">
                <div class="flex flex-col md:flex-row justify-between items-center py-3">
                    <div class="flex items-center mb-3 md:mb-0">
                        <h1 class="text-xl font-bold">ระบบจัดการคลังวัสดุ - กลุ่มงานระบาดวิทยา</h1>
                    </div>
                    <div class="flex flex-wrap justify-center">
                        <a href="#" class="nav-link active" data-page="stock">สต๊อกวัสดุ</a>
                        <a href="#" class="nav-link" data-page="withdraw">เบิกวัสดุ</a>
                        <a href="#" class="nav-link" data-page="receive">รับวัสดุ</a>
                        <a href="#" class="nav-link" data-page="history">ประวัติ</a>
                        <button id="logoutBtn" class="nav-link">ออกจากระบบ</button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Content Container -->
        <div class="container mx-auto px-4 py-6">
            <!-- Stock Page -->
            <div id="stockPage" class="page">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-[#0F4C3A]">รายการวัสดุในคลัง</h2>
                        <div class="flex space-x-2">
                            <input type="text" id="stockSearch" placeholder="ค้นหาวัสดุ..." class="form-input mb-0">
                            <button id="exportExcelBtn" class="btn-success">ส่งออก Excel</button>
                            <button id="addItemBtn" class="btn-primary">เพิ่มวัสดุใหม่</button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table id="stockTable" class="min-w-full">
                            <thead>
                                <tr>
                                    <th>รหัสบาร์โค้ด</th>
                                    <th>รายการวัสดุ</th>
                                    <th>จำนวนคงเหลือ</th>
                                    <th>หน่วยนับ</th>
                                    <th>วันหมดอายุ</th>
                                    <th>สถานะ</th>
                                    <th>จัดการ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Stock items will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Withdraw Page -->
            <div id="withdrawPage" class="page hidden">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-xl font-bold text-[#0F4C3A] mb-4">เบิกวัสดุ</h2>
                    
                    <form id="withdrawForm" class="mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="withdrawName">ชื่อผู้เบิก</label>
                                <input class="form-input mb-0" id="withdrawName" type="text" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="withdrawPosition">ตำแหน่ง</label>
                                <input class="form-input mb-0" id="withdrawPosition" type="text" required>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="withdrawPurpose">วัตถุประสงค์การใช้</label>
                            <textarea class="form-input mb-0" id="withdrawPurpose" rows="2" required></textarea>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="withdrawBarcode">แสกนบาร์โค้ด</label>
                            <input class="barcode-input" id="withdrawBarcode" type="text" placeholder="แสกนบาร์โค้ดที่นี่...">
                        </div>
                    </form>
                    
                    <div class="overflow-x-auto mb-6">
                        <table id="withdrawItemsTable" class="min-w-full">
                            <thead>
                                <tr>
                                    <th>รหัสบาร์โค้ด</th>
                                    <th>รายการวัสดุ</th>
                                    <th>จำนวนคงเหลือ</th>
                                    <th>หน่วยนับ</th>
                                    <th>จำนวนที่เบิก</th>
                                    <th>จัดการ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Withdraw items will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="flex justify-end">
                        <button id="withdrawSubmitBtn" class="btn-primary">บันทึกการเบิก</button>
                    </div>
                </div>
            </div>

            <!-- Receive Page -->
            <div id="receivePage" class="page hidden">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-xl font-bold text-[#0F4C3A] mb-4">รับวัสดุ</h2>
                    
                    <form id="receiveForm" class="mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="receiveSource">แหล่งที่มา</label>
                                <input class="form-input mb-0" id="receiveSource" type="text" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="receiveName">ผู้รับ</label>
                                <input class="form-input mb-0" id="receiveName" type="text" required>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="receiveBarcode">แสกนบาร์โค้ด</label>
                            <input class="barcode-input" id="receiveBarcode" type="text" placeholder="แสกนบาร์โค้ดที่นี่...">
                        </div>
                    </form>
                    
                    <div class="overflow-x-auto mb-6">
                        <table id="receiveItemsTable" class="min-w-full">
                            <thead>
                                <tr>
                                    <th>รหัสบาร์โค้ด</th>
                                    <th>รายการวัสดุ</th>
                                    <th>จำนวนคงเหลือ</th>
                                    <th>หน่วยนับ</th>
                                    <th>จำนวนที่รับ</th>
                                    <th>จัดการ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Receive items will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="flex justify-end">
                        <button id="addNewItemBtn" class="btn-secondary mr-2">เพิ่มรายการใหม่</button>
                        <button id="receiveSubmitBtn" class="btn-primary">บันทึกการรับ</button>
                    </div>
                </div>
            </div>

            <!-- History Page -->
            <div id="historyPage" class="page hidden">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-[#0F4C3A]">ประวัติการเบิก-รับวัสดุ</h2>
                        <div class="flex space-x-2">
                            <select id="historyType" class="form-input mb-0">
                                <option value="all">ทั้งหมด</option>
                                <option value="withdraw">การเบิก</option>
                                <option value="receive">การรับ</option>
                            </select>
                            <input type="date" id="historyDate" class="form-input mb-0">
                            <button id="historySearchBtn" class="btn-primary">ค้นหา</button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table id="historyTable" class="min-w-full">
                            <thead>
                                <tr>
                                    <th>วันที่-เวลา</th>
                                    <th>ประเภท</th>
                                    <th>ผู้เบิก</th>
                                    <th>รายละเอียด</th>
                                    <th>จัดการ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- History items will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add/Edit Item Modal -->
        <div id="itemModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2 id="modalTitle" class="text-xl font-bold text-[#0F4C3A] mb-4">เพิ่มวัสดุใหม่</h2>
                
                <form id="itemForm">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="itemBarcode">รหัสบาร์โค้ด</label>
                        <input class="form-input" id="itemBarcode" type="text" required>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="itemName">ชื่อวัสดุ</label>
                        <input class="form-input" id="itemName" type="text" required>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="itemUnit">หน่วยนับ</label>
                        <input class="form-input" id="itemUnit" type="text" required>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="itemQuantity">จำนวน</label>
                        <input class="form-input" id="itemQuantity" type="number" min="0" required>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="itemExpiry">วันหมดอายุ (ถ้ามี)</label>
                        <input class="form-input" id="itemExpiry" type="date">
                    </div>
                    
                    <div class="flex justify-end">
                        <button type="button" class="btn-secondary mr-2 close-modal">ยกเลิก</button>
                        <button type="submit" class="btn-primary">บันทึก</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Receipt Modal -->
        <div id="receiptModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <div id="receiptContent">
                    <div class="text-center mb-4">
                        <h2 class="text-xl font-bold">ใบเสร็จ</h2>
                        <p id="receiptType" class="text-lg"></p>
                        <p id="receiptDate"></p>
                    </div>
                    
                    <div class="mb-4">
                        <p><strong>ผู้เบิก:</strong> <span id="receiptPerson"></span></p>
                        <p id="receiptPositionContainer"><strong>ตำแหน่ง:</strong> <span id="receiptPosition"></span></p>
                        <p id="receiptPurposeContainer"><strong>วัตถุประสงค์:</strong> <span id="receiptPurpose"></span></p>
                        <p id="receiptSourceContainer"><strong>แหล่งที่มา:</strong> <span id="receiptSource"></span></p>
                    </div>
                    
                    <table class="min-w-full mb-4">
                        <thead>
                            <tr>
                                <th>รหัสบาร์โค้ด</th>
                                <th>รายการวัสดุ</th>
                                <th>จำนวน</th>
                                <th>หน่วยนับ</th>
                            </tr>
                        </thead>
                        <tbody id="receiptItems">
                            <!-- Receipt items will be populated here -->
                        </tbody>
                    </table>
                    
                    <div class="flex justify-between mt-8">
                        <div>
                            <p>ลงชื่อจ่าย___________________</p>
                        </div>
                        <div>
                            <p>ลงชื่อผู้เบิก___________________</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end mt-4 no-print">
                    <button id="printReceiptBtn" class="btn-secondary mr-2">พิมพ์</button>
                    <button id="saveReceiptPdfBtn" class="btn-primary">บันทึกเป็น PDF</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCV0T11S2xJZzRxq1wKlIYLKC2ZMbppDR0",
            authDomain: "epidbma-7ace1.firebaseapp.com",
            databaseURL: "https://epidbma-7ace1-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "epidbma-7ace1",
            storageBucket: "epidbma-7ace1.firebasestorage.app",
            messagingSenderId: "256371121756",
            appId: "1:256371121756:web:904b80ff04948ab7d0d099",
            measurementId: "G-M7MXGGVPRV"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        
        // Set Thai locale for moment.js
        moment.locale('th');
        
        // Global variables
        let currentUser = null;
        let stockItems = {};
        let withdrawItems = [];
        let receiveItems = [];
        let editingItemId = null;
        
        // DOM Elements
        const loginPage = document.getElementById('loginPage');
        const app = document.getElementById('app');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const logoutBtn = document.getElementById('logoutBtn');
        const navLinks = document.querySelectorAll('.nav-link[data-page]');
        const pages = document.querySelectorAll('.page');
        
        // Stock page elements
        const stockSearch = document.getElementById('stockSearch');
        const addItemBtn = document.getElementById('addItemBtn');
        const stockTable = document.getElementById('stockTable');
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        
        // Withdraw page elements
        const withdrawForm = document.getElementById('withdrawForm');
        const withdrawBarcode = document.getElementById('withdrawBarcode');
        const withdrawItemsTable = document.getElementById('withdrawItemsTable');
        const withdrawSubmitBtn = document.getElementById('withdrawSubmitBtn');
        
        // Receive page elements
        const receiveForm = document.getElementById('receiveForm');
        const receiveBarcode = document.getElementById('receiveBarcode');
        const receiveItemsTable = document.getElementById('receiveItemsTable');
        const addNewItemBtn = document.getElementById('addNewItemBtn');
        const receiveSubmitBtn = document.getElementById('receiveSubmitBtn');
        
        // History page elements
        const historyType = document.getElementById('historyType');
        const historyDate = document.getElementById('historyDate');
        const historySearchBtn = document.getElementById('historySearchBtn');
        const historyTable = document.getElementById('historyTable');
        
        // Modal elements
        const itemModal = document.getElementById('itemModal');
        const modalTitle = document.getElementById('modalTitle');
        const itemForm = document.getElementById('itemForm');
        const closeModalBtns = document.querySelectorAll('.close, .close-modal');
        
        // Receipt modal elements
        const receiptModal = document.getElementById('receiptModal');
        const printReceiptBtn = document.getElementById('printReceiptBtn');
        const saveReceiptPdfBtn = document.getElementById('saveReceiptPdfBtn');
        
        // Authentication
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            loginError.classList.add('hidden');
            
            auth.signInWithEmailAndPassword(email, password)
                .catch(function(error) {
                    loginError.textContent = `เกิดข้อผิดพลาด: ${error.message}`;
                    loginError.classList.remove('hidden');
                });
        });
        
        logoutBtn.addEventListener('click', function() {
            auth.signOut();
        });
        
        auth.onAuthStateChanged(function(user) {
            if (user) {
                currentUser = user;
                loginPage.classList.add('hidden');
                app.classList.remove('hidden');
                loadStockItems();
                loadHistoryItems();
            } else {
                currentUser = null;
                loginPage.classList.remove('hidden');
                app.classList.add('hidden');
                document.getElementById('email').value = '';
                document.getElementById('password').value = '';
            }
        });
        
        // Navigation
        navLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                const targetPage = this.getAttribute('data-page');
                
                navLinks.forEach(navLink => {
                    navLink.classList.remove('active');
                });
                
                this.classList.add('active');
                
                pages.forEach(page => {
                    page.classList.add('hidden');
                });
                
                document.getElementById(`${targetPage}Page`).classList.remove('hidden');
                
                // Refresh data when switching to pages
                if (targetPage === 'stock') {
                    loadStockItems();
                } else if (targetPage === 'history') {
                    loadHistoryItems();
                }
            });
        });
        
        // Stock Management
        function loadStockItems() {
            database.ref('stock').on('value', snapshot => {
                stockItems = snapshot.val() || {};
                renderStockTable();
            });
        }
        
        function renderStockTable() {
            const tbody = stockTable.querySelector('tbody');
            tbody.innerHTML = '';
            
            const searchTerm = stockSearch.value.toLowerCase();
            
            Object.keys(stockItems).forEach(id => {
                const item = stockItems[id];
                
                // Apply search filter
                if (searchTerm && !item.barcode.toLowerCase().includes(searchTerm) && 
                    !item.name.toLowerCase().includes(searchTerm)) {
                    return;
                }
                
                const row = document.createElement('tr');
                
                // Check expiry status
                let expiryStatus = '';
                let expiryClass = '';
                
                if (item.expiry) {
                    const expiryDate = new Date(item.expiry);
                    const today = new Date();
                    const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                    
                    if (daysUntilExpiry <= 0) {
                        expiryStatus = 'หมดอายุแล้ว';
                        expiryClass = 'expire-warning';
                    } else if (daysUntilExpiry <= 30) {
                        expiryStatus = `ใกล้หมดอายุ (${daysUntilExpiry} วัน)`;
                        expiryClass = 'expire-soon';
                    } else {
                        expiryStatus = 'ปกติ';
                    }
                } else {
                    expiryStatus = 'ไม่มีวันหมดอายุ';
                }
                
                row.innerHTML = `
                    <td>${item.barcode}</td>
                    <td>${item.name}</td>
                    <td>${item.quantity}</td>
                    <td>${item.unit}</td>
                    <td>${item.expiry ? moment(item.expiry).format('DD/MM/YYYY') : '-'}</td>
                    <td class="${expiryClass}">${expiryStatus}</td>
                    <td>
                        <button class="btn-secondary edit-item" data-id="${id}">แก้ไข</button>
                        <button class="btn-danger delete-item" data-id="${id}">ลบ</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            // Add event listeners to edit and delete buttons
            document.querySelectorAll('.edit-item').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    openEditItemModal(id);
                });
            });
            
            document.querySelectorAll('.delete-item').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    if (confirm('คุณต้องการลบรายการนี้ใช่หรือไม่?')) {
                        database.ref(`stock/${id}`).remove();
                    }
                });
            });
        }
        
        stockSearch.addEventListener('input', renderStockTable);
        
        addItemBtn.addEventListener('click', function() {
            openAddItemModal();
        });
        
        function openAddItemModal() {
            modalTitle.textContent = 'เพิ่มวัสดุใหม่';
            itemForm.reset();
            editingItemId = null;
            itemModal.style.display = 'block';
        }
        
        function openEditItemModal(id) {
            modalTitle.textContent = 'แก้ไขวัสดุ';
            editingItemId = id;
            
            const item = stockItems[id];
            document.getElementById('itemBarcode').value = item.barcode;
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemUnit').value = item.unit;
            document.getElementById('itemQuantity').value = item.quantity;
            document.getElementById('itemExpiry').value = item.expiry || '';
            
            itemModal.style.display = 'block';
        }
        
        itemForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const barcode = document.getElementById('itemBarcode').value;
            const name = document.getElementById('itemName').value;
            const unit = document.getElementById('itemUnit').value;
            const quantity = parseInt(document.getElementById('itemQuantity').value);
            const expiry = document.getElementById('itemExpiry').value || null;
            
            const itemData = {
                barcode,
                name,
                unit,
                quantity,
                expiry
            };
            
            if (editingItemId) {
                database.ref(`stock/${editingItemId}`).update(itemData);
            } else {
                // Check if barcode already exists
                let barcodeExists = false;
                Object.values(stockItems).forEach(item => {
                    if (item.barcode === barcode) {
                        barcodeExists = true;
                    }
                });
                
                if (barcodeExists) {
                    alert('รหัสบาร์โค้ดนี้มีอยู่ในระบบแล้ว');
                    return;
                }
                
                database.ref('stock').push(itemData);
            }
            
            itemModal.style.display = 'none';
        });
        
        // Close modals
        closeModalBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                itemModal.style.display = 'none';
                receiptModal.style.display = 'none';
            });
        });
        
        window.addEventListener('click', function(e) {
            if (e.target === itemModal) {
                itemModal.style.display = 'none';
            }
            if (e.target === receiptModal) {
                receiptModal.style.display = 'none';
            }
        });
        
        // Withdraw Management
        withdrawBarcode.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                
                const barcode = this.value.trim();
                if (!barcode) return;
                
                let found = false;
                Object.keys(stockItems).forEach(id => {
                    const item = stockItems[id];
                    if (item.barcode === barcode) {
                        found = true;
                        
                        // Check if item already in the list
                        const existingIndex = withdrawItems.findIndex(wi => wi.id === id);
                        if (existingIndex !== -1) {
                            // Increment quantity if already in list
                            withdrawItems[existingIndex].withdrawQuantity += 1;
                        } else {
                            // Add new item to list
                            withdrawItems.push({
                                id,
                                barcode: item.barcode,
                                name: item.name,
                                quantity: item.quantity,
                                unit: item.unit,
                                withdrawQuantity: 1
                            });
                        }
                        
                        renderWithdrawItemsTable();
                    }
                });
                
                if (!found) {
                    alert('ไม่พบรหัสบาร์โค้ดนี้ในระบบ');
                }
                
                this.value = '';
                this.focus();
            }
        });
        
        function renderWithdrawItemsTable() {
            const tbody = withdrawItemsTable.querySelector('tbody');
            tbody.innerHTML = '';
            
            withdrawItems.forEach((item, index) => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${item.barcode}</td>
                    <td>${item.name}</td>
                    <td>${item.quantity}</td>
                    <td>${item.unit}</td>
                    <td>
                        <input type="number" class="form-input mb-0 withdraw-quantity" 
                               data-index="${index}" value="${item.withdrawQuantity}" 
                               min="1" max="${item.quantity}">
                    </td>
                    <td>
                        <button class="btn-danger remove-withdraw-item" data-index="${index}">ลบ</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            // Add event listeners
            document.querySelectorAll('.withdraw-quantity').forEach(input => {
                input.addEventListener('change', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    const value = parseInt(this.value);
                    
                    if (value < 1) {
                        this.value = 1;
                        withdrawItems[index].withdrawQuantity = 1;
                    } else if (value > withdrawItems[index].quantity) {
                        this.value = withdrawItems[index].quantity;
                        withdrawItems[index].withdrawQuantity = withdrawItems[index].quantity;
                    } else {
                        withdrawItems[index].withdrawQuantity = value;
                    }
                });
            });
            
            document.querySelectorAll('.remove-withdraw-item').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    withdrawItems.splice(index, 1);
                    renderWithdrawItemsTable();
                });
            });
        }
        
        withdrawSubmitBtn.addEventListener('click', function() {
            if (withdrawItems.length === 0) {
                alert('กรุณาเพิ่มรายการวัสดุที่ต้องการเบิก');
                return;
            }
            
            const name = document.getElementById('withdrawName').value;
            const position = document.getElementById('withdrawPosition').value;
            const purpose = document.getElementById('withdrawPurpose').value;
            
            if (!name || !position || !purpose) {
                alert('กรุณากรอกข้อมูลให้ครบถ้วน');
                return;
            }
            
            // Create transaction record
            const timestamp = Date.now();
            const transaction = {
                type: 'withdraw',
                timestamp,
                date: moment().format('YYYY-MM-DD'),
                time: moment().format('HH:mm:ss'),
                name,
                position,
                purpose,
                items: withdrawItems.map(item => ({
                    id: item.id,
                    barcode: item.barcode,
                    name: item.name,
                    quantity: item.withdrawQuantity,
                    unit: item.unit
                }))
            };
            
            // Update stock quantities
            const updates = {};
            let hasError = false;
            
            withdrawItems.forEach(item => {
                const newQuantity = item.quantity - item.withdrawQuantity;
                
                if (newQuantity < 0) {
                    alert(`วัสดุ ${item.name} มีไม่เพียงพอสำหรับการเบิก`);
                    hasError = true;
                    return;
                }
                
                updates[`stock/${item.id}/quantity`] = newQuantity;
            });
            
            if (hasError) return;
            
            // Save transaction and update stock
            database.ref('transactions').push(transaction)
                .then(() => {
                    return database.ref().update(updates);
                })
                .then(() => {
                    showReceipt('withdraw', transaction);
                    
                    // Reset form
                    document.getElementById('withdrawName').value = '';
                    document.getElementById('withdrawPosition').value = '';
                    document.getElementById('withdrawPurpose').value = '';
                    withdrawItems = [];
                    renderWithdrawItemsTable();
                })
                .catch(error => {
                    alert(`เกิดข้อผิดพลาด: ${error.message}`);
                });
        });
        
        // Receive Management
        receiveBarcode.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                
                const barcode = this.value.trim();
                if (!barcode) return;
                
                let found = false;
                Object.keys(stockItems).forEach(id => {
                    const item = stockItems[id];
                    if (item.barcode === barcode) {
                        found = true;
                        
                        // Check if item already in the list
                        const existingIndex = receiveItems.findIndex(ri => ri.id === id);
                        if (existingIndex !== -1) {
                            // Increment quantity if already in list
                            receiveItems[existingIndex].receiveQuantity += 1;
                        } else {
                            // Add new item to list
                            receiveItems.push({
                                id,
                                barcode: item.barcode,
                                name: item.name,
                                quantity: item.quantity,
                                unit: item.unit,
                                receiveQuantity: 1,
                                isNew: false
                            });
                        }
                        
                        renderReceiveItemsTable();
                    }
                });
                
                if (!found) {
                    alert('ไม่พบรหัสบาร์โค้ดนี้ในระบบ กรุณาเพิ่มรายการใหม่');
                }
                
                this.value = '';
                this.focus();
            }
        });
        
        function renderReceiveItemsTable() {
            const tbody = receiveItemsTable.querySelector('tbody');
            tbody.innerHTML = '';
            
            receiveItems.forEach((item, index) => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${item.barcode}</td>
                    <td>${item.name}</td>
                    <td>${item.isNew ? 0 : item.quantity}</td>
                    <td>${item.unit}</td>
                    <td>
                        <input type="number" class="form-input mb-0 receive-quantity" 
                               data-index="${index}" value="${item.receiveQuantity}" min="1">
                    </td>
                    <td>
                        <button class="btn-danger remove-receive-item" data-index="${index}">ลบ</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            // Add event listeners
            document.querySelectorAll('.receive-quantity').forEach(input => {
                input.addEventListener('change', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    const value = parseInt(this.value);
                    
                    if (value < 1) {
                        this.value = 1;
                        receiveItems[index].receiveQuantity = 1;
                    } else {
                        receiveItems[index].receiveQuantity = value;
                    }
                });
            });
            
            document.querySelectorAll('.remove-receive-item').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    receiveItems.splice(index, 1);
                    renderReceiveItemsTable();
                });
            });
        }
        
        addNewItemBtn.addEventListener('click', function() {
            openAddItemModal();
            
            // Add event listener to add new item to receive list after saving
            const originalSubmitHandler = itemForm.onsubmit;
            
            itemForm.onsubmit = function(e) {
                e.preventDefault();
                
                const barcode = document.getElementById('itemBarcode').value;
                const name = document.getElementById('itemName').value;
                const unit = document.getElementById('itemUnit').value;
                const quantity = parseInt(document.getElementById('itemQuantity').value);
                const expiry = document.getElementById('itemExpiry').value || null;
                
                // Check if barcode already exists
                let barcodeExists = false;
                Object.values(stockItems).forEach(item => {
                    if (item.barcode === barcode) {
                        barcodeExists = true;
                    }
                });
                
                if (barcodeExists) {
                    alert('รหัสบาร์โค้ดนี้มีอยู่ในระบบแล้ว');
                    return;
                }
                
                // Add to receive items
                receiveItems.push({
                    barcode,
                    name,
                    unit,
                    quantity: 0,
                    receiveQuantity: quantity,
                    expiry,
                    isNew: true
                });
                
                renderReceiveItemsTable();
                itemModal.style.display = 'none';
                
                // Restore original submit handler
                itemForm.onsubmit = originalSubmitHandler;
            };
        });
        
        receiveSubmitBtn.addEventListener('click', function() {
            if (receiveItems.length === 0) {
                alert('กรุณาเพิ่มรายการวัสดุที่ต้องการรับ');
                return;
            }
            
            const source = document.getElementById('receiveSource').value;
            const name = document.getElementById('receiveName').value;
            
            if (!source || !name) {
                alert('กรุณากรอกข้อมูลให้ครบถ้วน');
                return;
            }
            
            // Create transaction record
            const timestamp = Date.now();
            const transaction = {
                type: 'receive',
                timestamp,
                date: moment().format('YYYY-MM-DD'),
                time: moment().format('HH:mm:ss'),
                source,
                name,
                items: receiveItems.map(item => ({
                    barcode: item.barcode,
                    name: item.name,
                    quantity: item.receiveQuantity,
                    unit: item.unit
                }))
            };
            
            // Update stock quantities or add new items
            const updates = {};
            const newItems = [];
            
            receiveItems.forEach(item => {
                if (item.isNew) {
                    // New item to be added to stock
                    newItems.push({
                        barcode: item.barcode,
                        name: item.name,
                        unit: item.unit,
                        quantity: item.receiveQuantity,
                        expiry: item.expiry || null
                    });
                } else {
                    // Update existing item quantity
                    const newQuantity = item.quantity + item.receiveQuantity;
                    updates[`stock/${item.id}/quantity`] = newQuantity;
                }
            });
            
            // Save transaction, update stock, and add new items
            database.ref('transactions').push(transaction)
                .then(() => {
                    // Update existing items
                    if (Object.keys(updates).length > 0) {
                        return database.ref().update(updates);
                    }
                    return Promise.resolve();
                })
                .then(() => {
                    // Add new items
                    const promises = newItems.map(item => database.ref('stock').push(item));
                    return Promise.all(promises);
                })
                .then(() => {
                    showReceipt('receive', transaction);
                    
                    // Reset form
                    document.getElementById('receiveSource').value = '';
                    document.getElementById('receiveName').value = '';
                    receiveItems = [];
                    renderReceiveItemsTable();
                })
                .catch(error => {
                    alert(`เกิดข้อผิดพลาด: ${error.message}`);
                });
        });
        
        // History Management
        function loadHistoryItems() {
            database.ref('transactions').on('value', snapshot => {
                const transactions = snapshot.val() || {};
                renderHistoryTable(transactions);
            });
        }
        
        function renderHistoryTable(transactions) {
            const tbody = historyTable.querySelector('tbody');
            tbody.innerHTML = '';
            
            const type = historyType.value;
            const date = historyDate.value;
            
            Object.keys(transactions).reverse().forEach(id => {
                const transaction = transactions[id];
                
                // Apply filters
                if (type !== 'all' && transaction.type !== type) {
                    return;
                }
                
                if (date && transaction.date !== date) {
                    return;
                }
                
                const row = document.createElement('tr');
                
                const typeText = transaction.type === 'withdraw' ? 'เบิก' : 'รับ';
                const personName = transaction.name;
                const dateTime = `${moment(transaction.date).format('DD/MM/YYYY')} ${transaction.time}`;
                
                let details = '';
                if (transaction.items && transaction.items.length > 0) {
                    details = `${transaction.items.length} รายการ`;
                }
                
                row.innerHTML = `
                    <td>${dateTime}</td>
                    <td>${typeText}</td>
                    <td>${personName}</td>
                    <td>${details}</td>
                    <td>
                        <button class="btn-primary view-history" data-id="${id}">ดูรายละเอียด</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            // Add event listeners
            document.querySelectorAll('.view-history').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    const transaction = transactions[id];
                    showReceipt(transaction.type, transaction);
                });
            });
        }
        
        historySearchBtn.addEventListener('click', function() {
            loadHistoryItems();
        });
        
        // Receipt Management
        function showReceipt(type, data) {
            const receiptType = document.getElementById('receiptType');
            const receiptDate = document.getElementById('receiptDate');
            const receiptPerson = document.getElementById('receiptPerson');
            const receiptPosition = document.getElementById('receiptPosition');
            const receiptPurpose = document.getElementById('receiptPurpose');
            const receiptSource = document.getElementById('receiptSource');
            const receiptItems = document.getElementById('receiptItems');
            
            const receiptPositionContainer = document.getElementById('receiptPositionContainer');
            const receiptPurposeContainer = document.getElementById('receiptPurposeContainer');
            const receiptSourceContainer = document.getElementById('receiptSourceContainer');
            
            // Set receipt type and title
            if (type === 'withdraw') {
                receiptType.textContent = 'ใบเบิกวัสดุ';
                receiptPositionContainer.style.display = 'block';
                receiptPurposeContainer.style.display = 'block';
                receiptSourceContainer.style.display = 'none';
            } else {
                receiptType.textContent = 'ใบรับวัสดุ';
                receiptPositionContainer.style.display = 'none';
                receiptPurposeContainer.style.display = 'none';
                receiptSourceContainer.style.display = 'block';
            }
            
            // Set receipt details
            receiptDate.textContent = `วันที่: ${moment(data.date).format('DD/MM/YYYY')} เวลา: ${data.time}`;
            receiptPerson.textContent = data.name;
            
            if (type === 'withdraw') {
                receiptPosition.textContent = data.position;
                receiptPurpose.textContent = data.purpose;
            } else {
                receiptSource.textContent = data.source;
            }
            
            // Set receipt items
            receiptItems.innerHTML = '';
            data.items.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.barcode}</td>
                    <td>${item.name}</td>
                    <td>${item.quantity}</td>
                    <td>${item.unit}</td>
                `;
                receiptItems.appendChild(row);
            });
            
            // Show receipt modal
            receiptModal.style.display = 'block';
        }
        
        printReceiptBtn.addEventListener('click', function() {
            window.print();
        });
        
        saveReceiptPdfBtn.addEventListener('click', function() {
            const { jsPDF } = window.jspdf;
            const receiptContent = document.getElementById('receiptContent');
            
            html2canvas(receiptContent).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save('receipt.pdf');
            });
        });
        
        // Export to Excel functionality
        exportExcelBtn.addEventListener('click', function() {
            exportStockToExcel();
        });
        
        function exportStockToExcel() {
            // Create worksheet data
            const worksheet = XLSX.utils.aoa_to_sheet([
                ['รายงานสต๊อกวัสดุ - กลุ่มงานระบาดวิทยา'],
                ['วันที่พิมพ์: ' + moment().format('DD/MM/YYYY HH:mm:ss')],
                [''],
                ['รหัสบาร์โค้ด', 'รายการวัสดุ', 'จำนวนคงเหลือ', 'หน่วยนับ', 'วันหมดอายุ', 'สถานะ']
            ]);
            
            // Add stock items to worksheet
            const stockData = [];
            Object.keys(stockItems).forEach(id => {
                const item = stockItems[id];
                
                // Check expiry status
                let expiryStatus = '';
                
                if (item.expiry) {
                    const expiryDate = new Date(item.expiry);
                    const today = new Date();
                    const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                    
                    if (daysUntilExpiry <= 0) {
                        expiryStatus = 'หมดอายุแล้ว';
                    } else if (daysUntilExpiry <= 30) {
                        expiryStatus = `ใกล้หมดอายุ (${daysUntilExpiry} วัน)`;
                    } else {
                        expiryStatus = 'ปกติ';
                    }
                } else {
                    expiryStatus = 'ไม่มีวันหมดอายุ';
                }
                
                stockData.push([
                    item.barcode,
                    item.name,
                    item.quantity,
                    item.unit,
                    item.expiry ? moment(item.expiry).format('DD/MM/YYYY') : '-',
                    expiryStatus
                ]);
            });
            
            // Append data to worksheet
            XLSX.utils.sheet_add_aoa(worksheet, stockData, { origin: 4 });
            
            // Create workbook and add worksheet
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'สต๊อกวัสดุ');
            
            // Set column widths
            const cols = [
                { wch: 15 }, // รหัสบาร์โค้ด
                { wch: 30 }, // รายการวัสดุ
                { wch: 15 }, // จำนวนคงเหลือ
                { wch: 10 }, // หน่วยนับ
                { wch: 15 }, // วันหมดอายุ
                { wch: 20 }  // สถานะ
            ];
            worksheet['!cols'] = cols;
            
            // Generate Excel file
            const today = moment().format('YYYYMMDD_HHmmss');
            XLSX.writeFile(workbook, `รายงานสต๊อกวัสดุ_${today}.xlsx`);
        }
        
        // Prevent page refresh issues
        window.addEventListener('beforeunload', function(e) {
            if (withdrawItems.length > 0 || receiveItems.length > 0) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'95487294e7bc45c0',t:'MTc1MDcyODQ5Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
